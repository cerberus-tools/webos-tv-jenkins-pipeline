pipeline {
    agent {
        label 'run-unittest'
    }

    stages {
        stage('Cleanup') {
            steps {
                script {
                    echo "Remove 'module' directory"
                    sh "sudo rm -rf module"
                    currentBuild.description = "<li>${env.GERRIT_PROJECT}</li><li>${env.GERRIT_CHANGE_NUMBER},${env.GERRIT_PATCHSET_NUMBER}</li><li>${env.GERRIT_EVENT_ACCOUNT_NAME}</li>"
                }
            }
        }
        stage('Checkout a change') {
            steps {
                script {
                    echo "Checkout a change from Gerrit"
                    sh "git clone ssh://${env.GERRIT_HOST}/${env.GERRIT_PROJECT} module 2>&1"
                    sh "cd module && git fetch origin ${env.GERRIT_REFSPEC} && git checkout FETCH_HEAD"
                }
            }
        }
        stage('Trigger Unit Test') {
            steps {
                script {
                    sh "cd module && docker-compose pull && docker-compose run run-test 2>&1"
                }
            }
        }
    }
}

